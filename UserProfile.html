<html lang="en">

<head>
    <title>UniLife Portfolio</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,900" rel="stylesheet">

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">

    <link rel="stylesheet" href="fonts/ionicons/css/ionicons.min.css">
    <link rel="stylesheet" href="fonts/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

    <!-- Theme Style -->
    <link rel="stylesheet" href="css/style.css">
</head>
<style>
    .followbadge {
        display: inline-block;
        padding: 0.25em 0.4em;
        font-size: 125%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        color: #fff;
        background-color: #007bff;
    }
</style>

<body>
    <header role="banner">

        <nav class="navbar navbar-expand-md navbar-dark bg-light">
            <div class="container">
                <a class="navbar-brand absolute" href="index.html">UniLife</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample05"
                    aria-controls="navbarsExample05" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse navbar-light" id="navbarsExample05">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="EventModule1.0.2\allEvent.html">Event</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="forum.html">Forum</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="portfolio.html">Portfolio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="SecondHand-BuyerListView.html">Second Hand Market</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav absolute-right">
                        <li class="nav-item">
                            <a href="login.html" class="nav-link" id="Login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a href="register.html" class="nav-link" id="Register">Register</a>
                        </li>
                        <li class="nav-item">
                            <a href="UserProfile.html" class="nav-link">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="SignOut">Sign Out</a>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>
    <!-- END header -->

    <section class="site-hero overlay" data-stellar-background-ratio="0.5"
        style="background-image: url(images/utar2.jpg);">
        <div class="container">
            <div class="row align-items-center site-hero-inner justify-content-center">
                <div class="col-md-8 text-center">

                    <div class="mb-5 element-animate">
                        <h1>User Profile</h1>
                        <p class="lead">All the information about the user in one page!! </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <body>


        <div class="container">
            <div class="row my-2">
                <div class="col-lg-8 order-lg-2">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a href="" data-target="#profile" data-toggle="tab" class="nav-link active"
                                id="profiletab">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a href="" data-target="#messages" data-toggle="tab" class="nav-link"
                                id="messagestab">Messages</a>
                        </li>
                        <li class="nav-item">
                            <a href="" data-target="#edit" data-toggle="tab" class="nav-link" id="edittab">Edit</a>
                        </li>
                    </ul>
                    <div class="tab-content py-4">
                        <div class="tab-pane active" id="profile">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-3" id="profileusername"></h5>
                                    <h6 id="profileFLname"></h6>
                                    <br>
                                    <h6><b>About</b></h6>
                                    <p id="profiledetails"></p>
                                    <p id="profilefaculty"></p>
                                    <br>
                                    <h6><b>Hobbies</b></h6>
                                    <p id="hobby"></p>
                                </div>
                                <div class="col-md-6">
                                    <a href="#" id="follow"><span class="followbadge">Follow</span></a>
                                    <h6>Acquired Skills</h6>
                                    <a href="#" class="badge badge-dark badge-pill">html5</a>
                                    <a href="#" class="badge badge-dark badge-pill">react</a>
                                    <a href="#" class="badge badge-dark badge-pill">codeply</a>
                                    <a href="#" class="badge badge-dark badge-pill">angularjs</a>
                                    <a href="#" class="badge badge-dark badge-pill">css3</a>
                                    <a href="#" class="badge badge-dark badge-pill">jquery</a>
                                    <a href="#" class="badge badge-dark badge-pill">bootstrap</a>
                                    <a href="#" class="badge badge-dark badge-pill">responsive-design</a>
                                    <hr>
                                    <span class="badge badge-primary" id="profilefollower">
                                        <i class="fa fa-user"></i></span>
                                    <span class="badge badge-danger" id="profileviews">
                                        <i class="fa fa-eye"></i></span>
                                    <br>
                                    <br>
                                    <h6><b>Rating Score</b></h6>
                                    <p id="ratingscore"></p>
                                </div>
                            </div>
                            <!--/row-->
                        </div>
                        <div class="tab-pane" id="messages">
                            <div class="alert alert-info alert-dismissable">
                                <a class="panel-close close" data-dismiss="alert">Ã—</a> This is an
                                <strong>.alert</strong>. Use this to show important messages to the user.
                            </div>
                            <table class="table table-hover table-striped">
                                <tbody>
                                    <tr>
                                        <td>
                                            <span class="float-right font-weight-bold">3 hrs ago</span> Here is your
                                            a
                                            link to the latest summary report from the..
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="float-right font-weight-bold">Yesterday</span> There has
                                            been a
                                            request on your account since that was..
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="float-right font-weight-bold">9/10</span> Porttitor vitae
                                            ultrices quis, dapibus id dolor. Morbi venenatis
                                            lacinia rhoncus.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="float-right font-weight-bold">9/4</span> Vestibulum
                                            tincidunt
                                            ullamcorper eros eget luctus.
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="float-right font-weight-bold">9/4</span> Maxamillion ais
                                            the
                                            fix for tibulum tincidunt ullamcorper eros.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="edit">
                            <form role="form" method="POST" id="profileform">
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">First name</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="text" id="firstname">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Last name</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="text" id="lastname">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Email</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="email" id="email" readonly>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Faculty</label>
                                    <div class="col-lg-9">
                                        <select id="faculty">
                                            <option value="NORMAL">None</option>
                                            <option value="FICT">FICT</option>
                                            <option value="FAS">FAS</option>
                                            <option value="FBF">FBF</option>
                                            <option value="FEGT">FEGT</option>
                                            <option value="CFS">CFS</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Student ID</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="text" id="studentid">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Address</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="text" placeholder="Street" id="street"
                                            required>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label"></label>
                                    <div class="col-lg-6">
                                        <input class="form-control" type="text" placeholder="City" id="city">
                                    </div>
                                    <div class="col-lg-3">
                                        <input class="form-control" type="text" placeholder="State" id="state">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">BirthDate</label>
                                    <div class="col-lg-6">
                                        <input class="form-control" type="date" id="BirthDateInput">
                                    </div>
                                    <div class="col-lg-3">
                                        <input class="form-control" type="text" id="BirthDate" readonly></input>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Username</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="text" id="username">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Hobbies</label>
                                    <div class="col-lg-9">
                                        <input class="form-control" type="text" id="hobbytext">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <input type="file" id="file" placeholder="Profile">
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label"></label>
                                    <div class="col-lg-9">
                                        <input type="submit" class="btn btn-primary" value="Save Changes"
                                            id="submitprofiles">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 order-lg-1 text-center">
                    <img src="images/defaultprofile.png" class="mx-auto img-fluid img-circle d-block" alt="avatar"
                        id="avatarjpg">
                    </label>
                </div>
            </div>
        </div>
        <footer class="site-footer" style="background-image: url(images/big_image_3.jpg);">
            <div class="container">
                <div class="row mb-5">
                    <div class="col-md-4">
                        <h3>Proudly present by</h3>
                        <br>
                        <p>
                            <a href="https://www.facebook.com/profile.php?id=100001364526377" target="_blank">
                                <img src="images/zhprofilepic.png" height="42" width="42">Liow Zi Hao</p>
                        </a>
                        <p>
                            <a href="https://www.facebook.com/TouWeiLoong" target="_blank">
                                <img src="images/wlprofilepic.png" height="42" width="42">Tou Wei Loong</p>
                        </a>
                        <p>
                            <a href="https://www.facebook.com/JxKnight" target="_blank">
                                <img src="images/jxprofilepic.png" height="42" width="42">Jia Xun
                                <br>
                        </p>
                        </a>
                        <p>
                            <a href="https://www.facebook.com/xinzhe.lee" target="_blank">
                                <img src="images/xzprofilepic.png" height="42" width="42">Lee Xin Zhe</p>
                        </a>
                    </div>
                </div>
            </div>
        </footer>




        <!-- loader -->
        <div id="loader" class="show fullscreen">
            <svg class="circular" width="48px" height="48px">
                <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
                <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10"
                    stroke="#f4b214" />
            </svg>
        </div>

        <script src="js/jquery-3.3.1.min.js"></script>
        <script src="js/jquery-migrate-3.0.0.js"></script>
        <script src="js/popper.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/owl.carousel.min.js"></script>
        <script src="js/jquery.waypoints.min.js"></script>
        <script src="js/jquery.stellar.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase.js"></script>
        <script src="AccountFirebase.js"></script>

        <script src="js/main.js"></script>

        <script>

            var file;
            var db = firebase.firestore();
            var externaluser = sessionStorage.getItem("UserID");
            $(function () {//onload$("#SignOut").show();
                $("#Login").hide();
                $("#Register").hide();
                sessionStorage.removeItem("UserID");
                sessionStorage.removeItem("Categories");
                sessionStorage.removeItem("ForumId");
                initApp();
                $("#follow").hide();
                $("#SignOut").click(function (e) {
                    firebase.auth().signOut();
                    alert("SignOut Success");
                });

                $('#file').on("change", function (evt) {

                    evt.stopPropagation();
                    evt.preventDefault();
                    file = evt.target.files[0];
                });
            });

            $("#follow").click(function (e) {
                var db = firebase.firestore();
                var obj = new Object();
                obj.CreatedDateTime = firebase.firestore.FieldValue.serverTimestamp();//assign value to CreatedDateTime  column 
                db.collection("Users").doc(firebase.auth().currentUser.uid).collection("Follow").doc(externaluser).set(obj).then(function (e) {
                    console.log("Followed");
                });
                db.collection("Users").doc(externaluser).collection("GetFollow").doc(firebase.auth().currentUser.uid).set(obj).then(function (e) {
                    console.log("GetFollowed");
                })
                var totalfollow = db.collection("Users").doc(externaluser);
                totalfollow.get().then(function (e) {
                    if (e.data().TotalGetFolllow == null) {
                        var total = 1;
                        totalfollow.update({
                            TotalGetFolllow: total
                        })
                        $("#profilefollower").html(total);
                    } else {
                        var total = e.data().TotalGetFolllow;
                        total = total + 1;
                        totalfollow.update({
                            TotalGetFolllow: total
                        })
                        $("#profilefollower").html(total);
                    }
                });
                getUser();
            });



            $("#profileform").submit(function (event) {
                event.preventDefault();//stop default action
                var user = firebase.auth().currentUser;
                var Usernamee = $("#username").val();
                db.collection("Users").doc(firebase.auth().currentUser.uid).get().then(function (checkdata) {
                    var check = checkdata.data().FirstName;
                    if (check != null) {
                        var street = $("#street").val();
                        var username = $("#username").val();
                        var city = $("#city").val();
                        var state = $("#state").val();
                        var HobbyText = $("#hobbytext").val();
                        db.collection("Users").doc(firebase.auth().currentUser.uid).update({
                            Address: street,
                            City: city,
                            State: state,
                            Username: username,
                            Hobbies: HobbyText
                        }).then(function (docRef) {
                            window.location.href = "index.html";
                        })
                            .catch(function (error) {
                                $("#errorMessage").show();
                                $("#errorMessage").html("Error adding document: " + error);
                            });
                    }
                    else {
                        var check = $("#firstname").val();
                        var metadata = { 'contentType': file.type };
                        var storageRef = firebase.storage().ref();
                        storageRef.child('users-profile/' + firebase.auth().currentUser.uid).put(file, metadata).then(function (snapshot) {
                            snapshot.ref.getDownloadURL().then(function (downloadURL) {
                                var userid = firebase.auth().currentUser.uid;
                                var firstName = $("#firstname").val();
                                var lastName = $("#lastname").val();
                                var faculty = $("#faculty").val();
                                var studentid = $("#studentid").val();
                                var street = $("#street").val();
                                var city = $("#city").val();
                                var state = $("#state").val();
                                var username = $("#username").val();
                                var BirthDate = $("#BirthDateInput").val()
                                var HobbyText = $("#hobbytext").val();
                                var RS = 0;
                                db.collection("Users").doc(userid).update({
                                    FirstName: firstName,
                                    LastName: lastName,
                                    Faculty: faculty,
                                    StudentID: studentid,
                                    Address: street,
                                    City: city,
                                    State: state,
                                    Username: username,
                                    BirthDate: BirthDate,
                                    Photo: downloadURL,
                                    Hobbies: HobbyText,
                                    RatingScore: RS
                                })
                                    .then(function (docRef) {
                                        window.location.href = "index.html";
                                    })
                                    .catch(function (error) {
                                        $("#errorMessage").show();
                                        $("#errorMessage").html("Error adding document: " + error);
                                    });
                            });
                        }).catch(function (error) {
                            // [START onfailure]

                            $("#errorMessage").show();
                            $("#errorMessage").html("Upload failed: " + error);

                            // [END onfailure]
                        });
                    }
                });
                user.updateProfile({
                    displayName: Usernamee
                })
                    .then(function () {
                        $("#errorMessage").show();
                        $("#errorMessage").html("Profile successfully updated!");
                    })
                    .catch(function (error) {
                        // The document probably doesn't exist.
                        $("#errorMessage").show();
                        $("#errorMessage").html("Error updating document: " + error);
                    });
            });


            function initApp() {
                //check user keep in cookie
                // Listening for auth state changes.
                // [START authstatelistener
                var user = firebase.auth().currentUser;
                firebase.auth().onAuthStateChanged(function (user) {
                    //alert(user.uid);
                    if (user === null) {
                        window.location.href = "Login.html";
                    }
                    else if (user.displayName === null) {
                        $("#profiletab").hide();
                        $("#profile").hide();
                        $("#messagestab").hide();
                        $("#messages").hide();
                        $("#edit").show();
                        $("#email").val(firebase.auth().currentUser.email);
                    }
                    else {
                        getUser();
                    }
                });
            };
            function getUser() {
                var checkuser = sessionStorage.getItem("UserID");
                if (checkuser == null) {
                    var db = firebase.firestore();//API firestore database
                    var user = firebase.auth().currentUser.uid;
                    var docRef = db.collection("Users").doc(user);
                    docRef.get().then(function (getUserDetails) {
                        if (getUserDetails.exists) {
                            //console.log(user.uid);
                            $("#firstname").val(getUserDetails.data().FirstName);
                            $("#firstname").attr('readonly', true);

                            $("#lastname").val(getUserDetails.data().LastName);
                            $("#lastname").attr('readonly', true);

                            $("#faculty").val(getUserDetails.data().Faculty);

                            $("#studentid").val(getUserDetails.data().StudentID);
                            $("#studentid").attr('readonly', true);

                            $("#street").val(getUserDetails.data().Address);

                            $("#city").val(getUserDetails.data().City);

                            $("#username").val(getUserDetails.data().Username);

                            $("#state").val(getUserDetails.data().State);

                            $("#BirthDate").val(getUserDetails.data().BirthDate);
                            $("#BirthDateInput").attr('readonly', true);

                            $("#avatarjpg").attr("src", getUserDetails.data().Photo);
                            $("#file").hide();

                            $("#email").val(getUserDetails.data().Email);

                            $("#hobbytext").val(getUserDetails.data().Hobbies);
                            console.log(getUserDetails.data().Hobbies);


                            $("#profileFLname").html("First Name: " + getUserDetails.data().FirstName + " Last Name: " + getUserDetails.data().LastName);
                            $("#profileusername").html("Username: " + getUserDetails.data().Username);
                            $("#profiledetails").html("Student ID: " + getUserDetails.data().StudentID);
                            $("#hobby").html(getUserDetails.data().Hobbies);
                            $("#profilefaculty").html("Faculty: " + getUserDetails.data().Faculty);
                            $("#profilefollower").html(getUserDetails.data().TotalGetFolllow);
                            $("#ratingscore").html(getUserDetails.data().RatingScore);
                        } else {
                            // doc.data() will be undefined in this case
                            alert("No such document!");
                        }
                    });
                } else {
                    $("#edittab").hide();
                    var db = firebase.firestore();//API firestore database
                    db.collection("Users").doc(firebase.auth().currentUser.uid).collection("Follow").doc(externaluser).get().then(function (e) {
                        if (e.exists) {
                            $("#follow").hide();
                        } else {
                            $("#follow").show();
                        }
                    })
                    var docRef = db.collection("Users").doc(checkuser);
                    docRef.get().then(function (getUserDetails) {
                        if (getUserDetails.exists) {
                            $("#profileFLname").html("First Name: " + getUserDetails.data().FirstName + " Last Name: " + getUserDetails.data().LastName);
                            $("#profileusername").html("Username: " + getUserDetails.data().Username);
                            $("#profiledetails").html("Student ID: " + getUserDetails.data().StudentID);
                            console.log("Faculty: " + getUserDetails.data().Faculty);
                            $("#hobby").html(getUserDetails.data().Hobbies);
                            $("#avatarjpg").attr("src", getUserDetails.data().Photo);
                            $("#profilefollower").html(getUserDetails.data().TotalGetFolllow);
                            $("#ratingscore").html(getUserDetails.data().RatingScore);
                        }
                    })
                }
            }
                // [END authstatelistener]
        </script>
    </body>

</html>