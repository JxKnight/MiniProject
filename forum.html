<html lang="en">

<head>
  <title>Forum Detail</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,900" rel="stylesheet">

  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/animate.css">
  <link rel="stylesheet" href="css/owl.carousel.min.css">
  <!-- register css -->
  <link rel="stylesheet" href="css/register/css/style.css">

  <link rel="stylesheet" href="fonts/ionicons/css/ionicons.min.css">
  <link rel="stylesheet" href="fonts/fontawesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

  <!-- Theme Style -->
  <link rel="stylesheet" href="css/style.css">
</head>
<style>
  .ftext {
    white-space: nowrap;
    width: 700px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .forumrow {
    width: 800px;
    height: 180px;
    border: 2px solid black;
    border-radius: 12px;
  }

  .readmore {
    text-align: right;
  }

  .forumul {
    overflow-x: hidden;
    white-space: nowrap;
    margin-left: -30;
    list-style: none;
  }

  .forumli {
    display: inline-block;
    width: auto;
    list-style: outside none none;
  }

  .formTopic {
    width: 60%;
    border: 1px solid #ced4da;
    background-color: #fff;
    line-height: 1.5;
    font-size: 1rem;
    padding: 0.375rem 0.75rem;
    display: block;
  }

  .formUsername {
    width: 40%;
    border: 1px solid #ced4da;
    background-color: #fff;
    line-height: 1.5;
    font-size: 1rem;
    padding: 0.375rem 0.75rem;
    display: block;
  }
</style>

<body>

  <header role="banner">
    <nav class="navbar navbar-expand-md navbar-dark bg-light">
      <div class="container">
        <a class="navbar-brand absolute" href="index.html">UniLife</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample05"
          aria-controls="navbarsExample05" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse navbar-light" id="navbarsExample05">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item">
              <a class="nav-link active" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="event.html">Event</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="forum.html">Forum</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="portfolio.html">Portfolio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="secondhandmarket.html">Second Hand Market</a>
            </li>
          </ul>
          <ul class="navbar-nav absolute-right">
            <li class="nav-item">
              <a href="userprofile.html" class="nav-link">Profile</a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="SignOut">Sign Out</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
  <!-- END header -->

  <section class="site-hero overlay" data-stellar-background-ratio="0.5"
    style="background-image: url(images/utar2.jpg);">
    <div class="container">
      <div class="row align-items-center site-hero-inner justify-content-center">
        <div class="col-md-8 text-center">

          <div class="mb-5 element-animate">
            <h1>Forum</h1>
            <p class="lead">Sharing is caring</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <body>

    <div id="colorlib-main" type="float: center">
      <div class="container">
        <div class="row my-2">
          <div class="col-lg-8 order-lg-2">
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <a href="" data-target="#CFORUM" data-toggle="tab" class="nav-link active" id="forumtab">Forum</a>
              </li>
              <li class="nav-item">
                <a href="" data-target="#CFS" data-toggle="tab" class="nav-link" id="cfstab">CFS</a>
              </li>
              <li class="nav-item">
                <a href="" data-target="#FICT" data-toggle="tab" class="nav-link" id="ficttab">FICT</a>
              </li>
              <li class="nav-item">
                <a href="" data-target="#FAS" data-toggle="tab" class="nav-link" id="fastab">FAS</a>
              </li>
              <li class="nav-item">
                <a href="" data-target="#FBF" data-toggle="tab" class="nav-link" id="fbftab">FBF</a>
              </li>
              <li class="nav-item">
                <a href="" data-target="#FEGT" data-toggle="tab" class="nav-link" id="fastab">FEGT</a>
              </li>
            </ul>
            <div class="tab-content py-4">
              <div class="tab-pane active" id="CFORUM">
                <form method="POST" id="profileform">
                  <div class="form-group row">
                    Topic:
                    <div class="col-lg-9">
                      <input class="formTopic" type="text" id="topic">
                    </div>
                  </div>
                  <div class="form-group row">
                    Current Username:
                    <div class="col-lg-9">
                      <input class="formUsername" type="text" id="username" readonly>
                    </div>
                  </div>
                  <div class="form-group row">
                    Select Faculty:
                    <div class="col-lg-9">
                      <select id="selectcategories">
                        <option value="NORMAL">None</option>
                        <option value="FICT">FICT</option>
                        <option value="FAS">FAS</option>
                        <option value="FBF">FBF</option>
                        <option value="FEGT">FEGT</option>
                        <option value="CFS">CFS</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group row">
                    Description:
                    <div class="col-lg-9">
                      <textarea rows="5" cols="75" type="text" id="text"></textarea>
                    </div>
                  </div>
                  <div class="form-group row">
                    <div class="col-lg-9">
                      <input type="file" id="forumfile">
                    </div>
                  </div>
                  <div class="form-group row">
                    <div class="col-lg-9">
                      <input type="submit" id="forumButton">
                    </div>
                  </div>
                </form>

              </div>
              <div class="tab-pane" id="CFS">

              </div>
              <div class="tab-pane" id="FICT">

              </div>
              <div class="tab-pane" id="FAS">

              </div>
              <div class="tab-pane" id="FBF">

              </div>
              <div class="tab-pane" id="FEGT">

              </div>
            </div>
          </div>
          <div class="col-lg-4 order-lg-1 text-center">
            <img src="images/forumicon.png" width="300" height="200">
            <div class="sidebar-box pt -md-4">
              <form action="#" class="search-form" id="searchforum">
                Search Forum Topic
                <div class="form-group">
                  <input type="text" class="form-control" placeholder="Type a keyword and hit enter" id="searchtext">
                  <input type="submit" style="position: absolute; left: -9999px; width: 1px; height: 1px;"
                    tabindex="-1" />
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>





      <!-- Start Footer -->
      <footer class="site-footer" style="background-image: url(images/big_image_3.jpg);">
        <div class="container">
          <div class="row mb-5">
            <div class="col-md-4">
              <h3>Proudly present by</h3>
              <br>
              <p>
                <a href="https://www.facebook.com/profile.php?id=100001364526377" target="_blank">
                  <img src="images/zhprofilepic.png" height="42" width="42">Liow Zi Hao</p>
              </a>
              <p>
                <a href="https://www.facebook.com/TouWeiLoong" target="_blank">
                  <img src="images/wlprofilepic.png" height="42" width="42">Tou Wei Loong</p>
              </a>
              <p>
                <a href="https://www.facebook.com/JxKnight" target="_blank">
                  <img src="images/jxprofilepic.png" height="42" width="42">Jia Xun
                  <br>
              </p>
              </a>
              <p>
                <a href="https://www.facebook.com/xinzhe.lee" target="_blank">
                  <img src="images/xzprofilepic.png" height="42" width="42">Lee Xin Zhe</p>
              </a>
            </div>
          </div>
        </div>
      </footer>
      <!-- loader -->
      <div id="loader" class="show fullscreen">
        <svg class="circular" width="48px" height="48px">
          <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
          <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10"
            stroke="#f4b214" />
        </svg>
      </div>

      <script src="js/jquery-3.3.1.min.js"></script>
      <script src="js/jquery-migrate-3.0.0.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.min.js"></script>
      <script src="js/owl.carousel.min.js"></script>
      <script src="js/jquery.waypoints.min.js"></script>
      <script src="js/jquery.stellar.min.js"></script>


      <script src="js/main.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase.js"></script>
      <script src="AccountFirebase.js"></script>



      <script>
        $(function () {//onload
          initApp();
          getForum();
          $("#SignOut").click(function (e) {
            firebase.auth().signOut();
            alert("SignOut Success");
          });

          $('#forumfile').on("change", function (evt) {
            evt.stopPropagation();
            evt.preventDefault();
            file = evt.target.files[0];
          });

          $(document.body).on('click', '.getForumId', function (e) { //btn-update class bind click event
            if (typeof (Storage) !== "undefined") {
              var forumid = $(this).data('id');
              sessionStorage.setItem("ForumId", forumid);
              var db = firebase.firestore();
              db.collection("Forum").onSnapshot(function (snapshot) {
                snapshot.docChanges().forEach(function (change) {
                  db.collection("Forum").doc(change.doc.id).collection("Post").onSnapshot(function (ssnapshot) {
                    ssnapshot.docChanges().forEach(function (cchange) {
                      if (cchange.doc.id == forumid) {
                        sessionStorage.setItem("Categories", change.doc.id);
                      }
                    })
                  })
                })
              })

              window.location.href = "forumdetail.html";//go to next page
            }
          });
        });

        function initApp() {
          //check user keep in cookie
          // Listening for auth state changes.
          // [START authstatelistener]
          firebase.auth().onAuthStateChanged(function (user) {
            if (user == null) {
              window.location.href = "Login.html";
            }
            else if (user.displayName == null) {
              window.location.href = "UserProfile.html";
            }
            else {
              $("#username").val(user.displayName);
              sessionStorage.removeItem("ForumId");
            }
            // else{
            //   getForum();
            // }
          });
          // [END authstatelistener]
        }


        function getForum() {
          var db = firebase.firestore();
          db.collection("Forum").onSnapshot(function (snapshot) {
            snapshot.docChanges().forEach(function (change) {
              db.collection("Forum").doc(change.doc.id).collection("Post").onSnapshot(function (ssnapshot) {
                ssnapshot.docChanges().forEach(function (cchange) {
                  //$("#" + change.doc.id).html("");
                  var date = ((cchange.doc.data().CreatedDateTime.toDate()).toString()).substring(0, 25);
                  //console.log(change.doc.id);
                  if (cchange.type === "added") {//Get realtime new added data  with Cloud Firestore
                    $("#" + change.doc.id).append('<div class=\"forumrow\" id=\"' + cchange.doc.id + '\"><a href=\"#\" class=\"getForumId\" data-id=\"' + cchange.doc.id + '\"><article class=\"col-xs-12\"><h2>' + cchange.doc.data().Topic + '</h2><p class=\"ftext\">' + cchange.doc.data().Text + '</p><p class=\"readmore\">Read More>>> </p><ul class=\"forumul\"><li class=\"forumli\"><small class=\"text-muted\">Date created:' + date + ' </small></li><li class=\"forumli\"><small class=\"text-muted\">Created by:' + cchange.doc.data().UN + '</small></li><li class=\"forumli\" style=\"float: right\">' + cchange.doc.data().TotalReply + 'Comments</li></ul></article></a></div><br>')
                    //$("#forumcontent").append('<div class=\"col-md-12\"  id=\"' + cchange.doc.id + '\"><div class=\"blog-entry ftco-animate d-md-flex\"><div class=\"text text-2 pl-md-4\"><h3 class=\"mb-2\"><a href=\"single.html\">' + cchange.doc.data().Topic + '</a></h3><small class=\"text-muted\"> Created by ' + cchange.doc.data().UN + '</small></h3><div class=\"meta-wrap\"><p class=\"meta\"><span><small class=\"text-muted\">' + cchange.doc.data().CreatedDateTime + '</small></span></p></div><p class=\"ftext\">' + cchange.doc.data().Text + '</p><p><a href=\"#\" class=\"btn-custom\" data-id=\"' + cchange.doc.id + '\">Read More<span class=\"ion-ios-arrow-forward\"></span></a></p></div></div></div>')
                    //console.log(change.doc.id);
                  }
                })
              })
            })
          })
        }

        $("#forumButton").click(function (event) {
          event.preventDefault();//stop default action
          var topic = ($("#topic").val().toString()).toUpperCase();
          var text = $("#text").val();//get content from textbox
          var categories = $("#selectcategories").val();
          var storageRef = firebase.storage().ref();
          var obj = new Object();//create table
          if (categories === "NONE") {
            categories = "N0ne";
          }
          obj.Topic = topic;//assign value to Name column 
          obj.Uid = firebase.auth().currentUser.uid;//assign value to Uid column 
          obj.UN = firebase.auth().currentUser.displayName;//assign value to Uid column 
          obj.Text = text;//assign value to text column
          obj.TotalReply = 0;
          obj.TopicUidText = topic + firebase.auth().currentUser.uid + text;
          obj.CreatedDateTime = firebase.firestore.FieldValue.serverTimestamp();//assign value to CreatedDateTime  column 
          obj.UpdatedDateTime = firebase.firestore.FieldValue.serverTimestamp();//assign value to UpdatedDateTimeDateTime column 
          var db = firebase.firestore();//API firestore database
          var post = db.collection("Forum").doc(categories).collection("Post");
          post.add(obj).then(function (docRef) {
            $("#topic").val("");
            $("#text").val("");
            $("#topic").focus();
            if ($('#forumfile') != "") {
              post.onSnapshot(function (snapshot) {
                snapshot.docChanges().forEach(function (change) {
                  //console.log(change.doc.data().CreatedDateTime.toDate());
                  if ((change.doc.data().TopicUidText) == obj.TopicUidText) {
                    var storageRef = firebase.storage().ref();
                    var metadata = { 'contentType': file.type };
                    storageRef.child('forum-picture/' + change.doc.id).put(file, metadata).then(function (ssnapshot) {
                      ssnapshot.ref.getDownloadURL().then(function (downloadURL) {
                        post.doc(change.doc.id).update({
                          Photo: downloadURL
                        }).catch(function (error) {
                          $("#errorMessage").show();
                          $("#errorMessage").html("Error adding document: " + error);
                        });
                      })
                    })
                  }
                })
              })
              alert("Insert Successfully");
              getForum();
            }
          })
        })
        $("#searchforum").submit(function (event) {
          event.preventDefault();
          var topic = ($("#searchtext").val().toString()).toUpperCase();
          var db = firebase.firestore().collection("Forum");
          db.onSnapshot(function (snapshot) {
            snapshot.docChanges().forEach(function (getcategories) {
              console.log(getcategories.doc.id);
              $("#" + getcategories.doc.id).html("");
              db.doc(getcategories.doc.id).collection("Post").onSnapshot(function (ssnapshot) {
                ssnapshot.docChanges().forEach(function (getforum) {
                  //console.log(getforum.doc.data().Topic);
                  if (getforum.doc.data().Topic === topic) {
                    //console.log(getcategories.doc.id);
                    var date = ((getforum.doc.data().CreatedDateTime.toDate()).toString()).substring(0, 25);
                    if (getforum.type === "added") {//Get realtime new added data  with Cloud Firestore
                      $("#" + getcategories.doc.id).append('<div class=\"forumrow\" id=\"' + getforum.doc.id + '\"><a href=\"#\" class=\"getForumId\" data-id=\"' + getforum.doc.id + '\"><article class=\"col-xs-12\"><h2>' + getforum.doc.data().Topic + '</h2><p class=\"ftext\">' + getforum.doc.data().Text + '</p><p class=\"readmore\">Read More>>> </p><ul class=\"forumul\"><li class=\"forumli\"><small class=\"text-muted\">Date created:' + date + ' </small></li><li class=\"forumli\"><small class=\"text-muted\">Created by:' + getforum.doc.data().UN + '</small></li><li class=\"forumli\" style=\"float: right\">' + getforum.doc.data().TotalReply + 'Comments</li></ul></article></a></div><br>')
                    }
                    if (getforum.type === "modified") {//Get realtime update data with Cloud Firestore
                      var id = "#" + cchange.doc.id;
                      $("#" + getcategories.doc.id).append('<div class=\"forumrow\" id=\"' + getforum.doc.id + '\"><a href=\"#\" class=\"getForumId\" data-id=\"' + getforum.doc.id + '\"><article class=\"col-xs-12\"><h2>' + getforum.doc.data().Topic + '</h2><p class=\"ftext\">' + getforum.doc.data().Text + '</p><p class=\"readmore\">Read More>>> </p><ul class=\"forumul\"><li class=\"forumli\"><small class=\"text-muted\">Date created:' + date + ' </small></li><li class=\"forumli\"><small class=\"text-muted\">Created by:' + getforum.doc.data().UN + '</small></li><li class=\"forumli\" style=\"float: right\">' + getforum.doc.data().TotalReply + 'Comments</li></ul></article></a></div><br>')
                    }
                  }
                })
              })
            })
          })
        })
      </script>

  </body>

</html>